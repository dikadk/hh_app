import 'package:flutter_test/flutter_test.dart';
import 'package:hn_app/src/article.dart';
import 'package:http/http.dart' as http;

void main() {
  test("parse top stories", () {
    const jsonString =
        "[22266173,22269115,22268496,22268248,22268941,22264553,22265197,22266722,22257189,22259025,22264633,22268944,22263721,22268611,22265235,22255757,22267393,22263274,22259334,22256666,22266966,22258806,22268861,22258651,22268986,22267341,22265664,22268450,22266981,22266070,22255156,22255610,22263758,22264164,22266987,22265397,22268440,22267547,22266386,22255758,22255318,22247543,22267571,22264918,22267986,22264043,22264914,22261612,22268118,22269394,22266710,22255694,22263996,22267092,22255491,22255681,22262964,22268776,22258113,22261530,22258837,22263429,22255914,22255301,22264104,22247292,22268177,22260303,22267842,22266593,22264671,22255637,22262339,22262855,22255715,22266747,22267529,22264448,22255734,22261670,22260731,22244750,22259563,22252330,22260302,22253961,22263603,22257613,22246442,22258198,22255268,22256275,22261041,22258180,22263022,22247301,22265096,22265700,22255762,22248325,22262138,22254793,22257630,22254958,22233074,22260047,22269006,22254499,22253977,22249811,22251076,22256026,22260542,22233937,22264178,22249424,22257448,22254802,22251079,22244706,22252727,22248131,22255336,22257889,22264481,22257191,22254589,22250614,22236106,22258162,22255308,22246562,22247899,22256055,22253782,22237554,22256564,22258969,22254742,22254083,22248351,22265849,22253290,22246615,22245409,22263314,22253516,22256642,22249662,22251797,22252557,22264744,22226380,22253131,22238335,22248389,22242478,22250733,22257635,22248702,22246542,22242659,22248456,22255846,22256872,22248329,22242942,22244419,22256496,22264576,22233295,22257337,22234884,22246334,22260561,22244109,22234999,22251259,22259026,22263241,22260830,22245977,22249329,22257427,22246732,22248239,22263783,22253893,22228083,22253844,22255305,22252044,22231922,22232705,22259833,22250847,22227252,22259356,22231963,22237043,22256103,22253272,22245788,22237528,22246887,22262462,22224277,22235355,22255572,22234730,22247499,22249759,22259683,22237145,22263304,22251017,22230617,22263354,22250758,22247295,22257192,22262813,22251091,22241884,22248974,22252191,22260034,22244086,22264492,22243823,22235279,22240208,22240041,22262905,22263298,22242720,22251014,22233007,22259121,22255882,22226442,22234590,22258777,22243270,22252720,22249875,22261197,22245534,22254642,22241737,22241020,22241251,22245719,22263582,22249843,22256469,22235188,22256382,22264057,22253247,22251329,22226148,22251867,22234575,22242528,22261640,22260912,22240473,22241533,22251123,22239737,22225851,22233457,22247551,22242411,22237127,22259757,22251167,22246004,22261341,22255584,22232395,22262467,22263245,22232633,22263847,22250501,22240433,22260038,22242358,22243101,22235338,22253785,22250350,22257374,22249256,22247026,22241033,22226532,22232036,22225436,22238821,22236083,22224782,22225372,22246793,22228639,22263492,22227266,22237745,22242506,22224582,22241786,22255035,22251388,22232383,22255813,22236577,22237104,22225136,22254760,22224498,22226382,22234591,22252137,22241877,22246774,22234320,22263348,22246339,22233054,22231597,22225312,22250878,22229204,22227993,22251325,22249015,22242280,22231944,22243373,22230168,22252150,22233821,22231227,22229109,22231579,22253560,22225263,22234399,22225314,22228220,22251237,22226365,22233109,22255508,22233032,22240533,22259233,22257350,22227860,22237740,22251416,22233156,22246104,22244445,22249828,22263829,22249798,22226419,22252274,22225313,22229666,22234765,22254864,22228449,22233113,22252199,22252829,22249035,22258340,22248958,22235756,22252725,22231096,22252838,22258929,22256244,22253234,22232473,22250659,22234718,22229712,22253972,22252290,22246810,22242869,22234709,22252023,22248258,22253981,22251522,22259125,22238196,22261599,22251173,22228071,22244154,22250425,22239706,22228879,22228700,22249966,22225255,22242416,22255995,22236635,22226685,22251180,22255354,22247013,22227244,22240817,22235321,22232168,22254237,22238265,22247743,22256351,22246861,22247107,22263495,22231387,22229152,22231760,22243011,22249171,22226300,22248587,22231537,22245701,22258457,22258357,22258304,22229074,22234936,22232737,22249233,22253177,22250608,22251852,22237286,22250063,22257329,22243917,22254885,22251214,22238387,22234622,22251093,22244202,22237060,22232598,22258344,22250706,22259916,22256296,22256307,22235762,22229431,22226374,22235934,22232967,22259258,22229299,22251011,22234042,22253191,22237798,22250837,22252578,22251107,22233700,22255414,22228396,22227844,22253542,22253507,22255200,22240505,22246755,22226066,22249267,22260266,22238860,22232439,22257657,22253476,22238269,22247782]";

    expect(parseTopStories(jsonString).first, 22266173);
  });

  test("parse article.json", () {
    const jsonString =
        '{"by":"dhouston","descendants":71,"id":8863,"kids":[9224,8917,8952,8884,8887,8869,8958,8940,8908,9005,8873,9671,9067,9055,8865,8881,8872,8955,10403,8903,8928,9125,8998,8901,8902,8907,8894,8870,8878,8980,8934,8943,8876],"score":104,"time":1175714200,"title":"My YC app: Dropbox - Throw away your USB drive","type":"story","url":"http://www.getdropbox.com/u/2/screencast.html"}';

    expect(parseArticle(jsonString).by, "dhouston");
  });

  test("parces item.json over network", () async {
    final url = 'https://hacker-news.firebaseio.com/v0/beststories.json';
    final response = await http.get(url);
    if (response.statusCode == 200) {
      final idList = parseTopStories(response.body);
      if (idList.isNotEmpty) {
        final storyUrl =
            'https://hacker-news.firebaseio.com/v0/item/${idList.first}.json';
        final storyRes = await http.get(storyUrl);
        if (storyRes.statusCode == 200) {
          expect(parseArticle(storyRes.body), isNotNull);
        }
      }
    }
  });
}
